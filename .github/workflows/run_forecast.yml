name: Forecast Pipeline

on:
  workflow_dispatch:
    inputs:
      user_question:
        description: 'User question JSON (leave blank for normal mode - will generate 3 questions)'
        required: false
        default: ''
      topic:
        description: 'Topic for question generation (normal mode only)'
        required: false
        default: 'Current events and trends'
      max_questions:
        description: 'Maximum number of questions to process'
        required: false
        default: '3'
      enable_panshul:
        description: 'Enable Panshul bot'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'
      panshul_mode:
        description: 'Panshul mode (full or fast)'
        required: false
        default: 'full'
        type: choice
        options:
          - full
          - fast
      enable_methods:
        description: 'Enable method runner (KM/BD/EX)'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'
      enable_veo:
        description: 'Enable Veo script generation'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

jobs:
  forecast:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          
      - name: Install ffmpeg
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg
          
      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Determine mode
        id: mode
        run: |
          USER_Q='${{ github.event.inputs.user_question }}'
          if [ -n "$USER_Q" ]; then
            echo "mode=user" >> $GITHUB_OUTPUT
            echo "ðŸŽ¯ Running in USER MODE (custom question provided)"
          else
            echo "mode=normal" >> $GITHUB_OUTPUT
            echo "ðŸŽ¯ Running in NORMAL MODE (generating ${{ github.event.inputs.max_questions }} questions about '${{ github.event.inputs.topic }}')"
          fi
      
      - name: Run forecast pipeline
        env:
          # API Keys
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          SERPER_API_KEY: ${{ secrets.SERPER_API_KEY }}
          SERPER_KEY: ${{ secrets.SERPER_API_KEY }}
          ASKNEWS_CLIENT_ID: ${{ secrets.ASKNEWS_CLIENT_ID }}
          ASKNEWS_SECRET: ${{ secrets.ASKNEWS_SECRET }}
          NEWSDATA_KEY: ${{ secrets.NEWSDATA_KEY }}
          NEWSAPI_KEY: ${{ secrets.NEWSAPI_KEY }}
          PERPLEXITY_API_KEY: ${{ secrets.PERPLEXITY_API_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          
          # Model Configuration
          MODEL_RS: ${{ secrets.MODEL_RS }}
          MODEL_QG: ${{ secrets.MODEL_QG }}
          MODEL_FC: ${{ secrets.MODEL_FC }}
          MODEL_BK: ${{ secrets.MODEL_BK }}
          
          # Prompts - FIXED: Split RS into RS1 and RS2
          PROMPT_RS1: ${{ secrets.PROMPT_RS1 }}
          PROMPT_RS2: ${{ secrets.PROMPT_RS2 }}
          PROMPT_QG: ${{ secrets.PROMPT_QG }}
          PROMPT_KM_PT1: ${{ secrets.PROMPT_KM_PT1 }}
          PROMPT_KM_PT2: ${{ secrets.PROMPT_KM_PT2 }}
          PROMPT_BD_PT1: ${{ secrets.PROMPT_BD_PT1 }}
          PROMPT_BD_PT2: ${{ secrets.PROMPT_BD_PT2 }}
          PROMPT_EX_PT1: ${{ secrets.PROMPT_EX_PT1 }}
          PROMPT_EX_PT2: ${{ secrets.PROMPT_EX_PT2 }}
          PROMPT_FINAL_COMBINER: ${{ secrets.PROMPT_FINAL_COMBINER }}
          PROMPT_REPORTER: ${{ secrets.PROMPT_REPORTER }}
          PROMPT_REPORTER1: ${{ secrets.PROMPT_REPORTER1 }}
          PROMPT_REPORTER2: ${{ secrets.PROMPT_REPORTER2 }}
          
          # Pipeline Configuration
          MODE: ${{ steps.mode.outputs.mode }}
          USER_QUESTION_JSON: ${{ github.event.inputs.user_question }}
          TOPIC: ${{ github.event.inputs.topic }}
          MAX_QUESTIONS: ${{ github.event.inputs.max_questions }}
          ENABLE_PANSHUL: ${{ github.event.inputs.enable_panshul }}
          PANSHUL_MODE: ${{ github.event.inputs.panshul_mode }}
          ENABLE_METHODS: ${{ github.event.inputs.enable_methods }}
          ENABLE_VEO: ${{ github.event.inputs.enable_veo }}
        run: |
          python forecast_orchestrator.py
      
      - name: Upload forecast outputs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: forecast-outputs
          path: out/
          retention-days: 30
      
      - name: Generate summary
        if: always()
        run: |
          echo "## Forecast Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Mode:** ${{ steps.mode.outputs.mode }}" >> $GITHUB_STEP_SUMMARY
          echo "**Panshul Mode:** ${{ github.event.inputs.panshul_mode }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "out/state.json" ]; then
            echo "### State" >> $GITHUB_STEP_SUMMARY
            echo '```json' >> $GITHUB_STEP_SUMMARY
            cat out/state.json >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
