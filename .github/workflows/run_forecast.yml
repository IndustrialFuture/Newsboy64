name: Forecast Pipeline

on:
  workflow_dispatch:
    inputs:
      mode:
        description: 'Run mode'
        required: true
        type: choice
        options:
          - 'normal'
          - 'user'
        default: 'normal'
      
      topic:
        description: 'Topic for question generation (normal mode only)'
        required: false
        type: string
        default: 'Current events and trends'
      
      user_question:
        description: 'Single question JSON (user mode only)'
        required: false
        type: string
        default: ''
      
      max_questions:
        description: 'Max questions to generate (normal mode)'
        required: false
        type: number
        default: 3
      
      enable_panshul:
        description: 'Enable Panshul bot'
        required: false
        type: boolean
        default: true
      
      enable_methods:
        description: 'Enable KM/BD/EX methods'
        required: false
        type: boolean
        default: true
      
      enable_veo:
        description: 'Enable Veo script generation'
        required: false
        type: boolean
        default: true

jobs:
  forecast:
    runs-on: ubuntu-latest
    timeout-minutes: 180  # 3 hours max
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Run Forecast Pipeline (Normal Mode)
        if: ${{ github.event.inputs.mode == 'normal' }}
        env:
          # API Keys
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          SERPER_API_KEY: ${{ secrets.SERPER_API_KEY }}
          ASKNEWS_CLIENT_ID: ${{ secrets.ASKNEWS_CLIENT_ID }}
          ASKNEWS_SECRET: ${{ secrets.ASKNEWS_SECRET }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          
          # Models
          MODEL_RS: ${{ secrets.MODEL_RS }}
          MODEL_QG: ${{ secrets.MODEL_QG }}
          MODEL_FC: ${{ secrets.MODEL_FC }}
          MODEL_BK: ${{ secrets.MODEL_BK }}
          
          # Prompts
          PROMPT_RS1: ${{ secrets.PROMPT_RS1 }}
          PROMPT_RS2: ${{ secrets.PROMPT_RS2 }}
          PROMPT_QG: ${{ secrets.PROMPT_QG }}
          PROMPT_KM_PT1: ${{ secrets.PROMPT_KM_PT1 }}
          PROMPT_KM_PT2: ${{ secrets.PROMPT_KM_PT2 }}
          PROMPT_BD_PT1: ${{ secrets.PROMPT_BD_PT1 }}
          PROMPT_BD_PT2: ${{ secrets.PROMPT_BD_PT2 }}
          PROMPT_EX_PT1: ${{ secrets.PROMPT_EX_PT1 }}
          PROMPT_EX_PT2: ${{ secrets.PROMPT_EX_PT2 }}
          PROMPT_FINAL_COMBINER: ${{ secrets.PROMPT_FINAL_COMBINER }}
          PROMPT_REPORTER: ${{ secrets.PROMPT_REPORTER }}
          
          # Config
          TOPIC: ${{ github.event.inputs.topic }}
          MAX_QUESTIONS: ${{ github.event.inputs.max_questions }}
          ENABLE_PANSHUL: ${{ github.event.inputs.enable_panshul }}
          ENABLE_METHODS: ${{ github.event.inputs.enable_methods }}
          ENABLE_VEO: ${{ github.event.inputs.enable_veo }}
        run: |
          python forecast_orchestrator.py
      
      - name: Run Forecast Pipeline (User Mode)
        if: ${{ github.event.inputs.mode == 'user' }}
        env:
          # API Keys
          OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
          SERPER_API_KEY: ${{ secrets.SERPER_API_KEY }}
          ASKNEWS_CLIENT_ID: ${{ secrets.ASKNEWS_CLIENT_ID }}
          ASKNEWS_SECRET: ${{ secrets.ASKNEWS_SECRET }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          
          # Models
          MODEL_RS: ${{ secrets.MODEL_RS }}
          MODEL_QG: ${{ secrets.MODEL_QG }}
          MODEL_FC: ${{ secrets.MODEL_FC }}
          MODEL_BK: ${{ secrets.MODEL_BK }}
          
          # Prompts
          PROMPT_KM_PT1: ${{ secrets.PROMPT_KM_PT1 }}
          PROMPT_KM_PT2: ${{ secrets.PROMPT_KM_PT2 }}
          PROMPT_BD_PT1: ${{ secrets.PROMPT_BD_PT1 }}
          PROMPT_BD_PT2: ${{ secrets.PROMPT_BD_PT2 }}
          PROMPT_EX_PT1: ${{ secrets.PROMPT_EX_PT1 }}
          PROMPT_EX_PT2: ${{ secrets.PROMPT_EX_PT2 }}
          PROMPT_FINAL_COMBINER: ${{ secrets.PROMPT_FINAL_COMBINER }}
          
          # User question
          USER_QUESTION_JSON: ${{ github.event.inputs.user_question }}
          
          # Config
          ENABLE_PANSHUL: ${{ github.event.inputs.enable_panshul }}
          ENABLE_METHODS: ${{ github.event.inputs.enable_methods }}
        run: |
          python forecast_orchestrator.py
      
      - name: Upload outputs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: forecast-outputs
          path: out/
          retention-days: 30
      
      - name: Display summary
        if: always()
        run: |
          echo "## Forecast Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "out/state.json" ]; then
            echo "### State" >> $GITHUB_STEP_SUMMARY
